<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>GestÃ£o de Produtos</title>
    <link rel="stylesheet" href="Bootstrap/css/bootstrap.css" />
    <link rel="stylesheet" href="Bootstrap/bootstrap-icons.css" />
    <link rel="stylesheet" href="produtos.css" />
    <script src="chart.min.js"></script>
</head>
<body>
<div class="container py-4">
    <h2 class="text-center mb-4">GestÃ£o de Produtos</h2>

    <!-- NavegaÃ§Ã£o -->
    <ul class="nav nav-tabs" id="tabMenu" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="pedidos-tab" data-bs-toggle="tab" href="#pedidos" role="tab">Pedidos de Produtos</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="estoque-tab" data-bs-toggle="tab" href="#estoque" role="tab">Estoque / Consumo</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="graficos-tab" data-bs-toggle="tab" href="#graficos" role="tab">RelatÃ³rios / GrÃ¡ficos</a>
        </li>
    </ul>

    <!-- ConteÃºdo das Abas -->
    <div class="tab-content mt-3">
        <!-- Aba 1: Pedidos -->
        <div class="tab-pane fade show active" id="pedidos" role="tabpanel">
            <h4>Adicionar Pedido de Produto</h4>
            <div id="listaProdutos"></div>
            <button id="finalizarPedidos" class="btn btn-success mt-3">
                <i class="bi bi-check-circle me-1"></i> Finalizar Pedidos
            </button>
        </div>

        <!-- Aba 2: Estoque -->
        <div class="tab-pane fade" id="estoque" role="tabpanel">
            <h4>Estoque / Consumo</h4>

            <h5>ðŸ“¦ Estoque Atual</h5>
            <table class="table table-bordered table-striped table-sm" id="tabelaEstoqueAtual">
                <thead class="table-dark">
                <tr>
                    <th>CÃ³digo</th>
                    <th>Produto</th>
                    <th>Embalagem</th>
                    <th>Qtd Atual</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>


            <table class="table table-bordered table-striped" id="tabelaEstoque">
                <thead class="table-dark">
                <tr>
                    <th>CÃ³digo</th>
                    <th>Produto</th>
                    <th>Embalagem</th>
                    <th>Quantidade</th>
                    <th>PreÃ§o UnitÃ¡rio</th>
                    <th>PreÃ§o Total</th>
                    <th>Data</th>
                </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                <tr class="table-secondary fw-bold">
                    <td colspan="5" class="text-end">Total da Semana:</td>
                    <td id="totalSemana">R$ 0,00</td>
                    <td></td>
                </tr>
                </tfoot>
            </table>
        </div>
        <div class="tab-pane fade" id="graficos" role="tabpanel">
            <!-- ðŸ“Š ABA 3: GRÃFICOS -->
            <!-- ABA DE GRÃFICOS -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <h5>Resumo da Semana</h5>
                <button id="expandirSemana" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-arrows-fullscreen"></i> Tela cheia
                </button>
            </div>
            <div class="grafico-wrapper position-relative text-center">
                <canvas id="graficoSemana"></canvas>
                <button class="btn btn-sm btn-danger btn-fullscreen-close">âœ• Sair</button>
            </div>


            <div class="d-flex justify-content-between align-items-center mt-4">
                <h5>Resumo do MÃªs</h5>
                <button id="expandirMes" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-arrows-fullscreen"></i> Tela cheia
                </button>
            </div>
            <div class="grafico-wrapper position-relative text-center">
                <canvas id="graficoMes"></canvas>
                <button class="btn btn-sm btn-danger btn-fullscreen-close">âœ• Sair</button>
            </div>
        </div>

    </div>
</div>

<!-- MODAL DE OPÃ‡Ã•ES -->
<div class="modal fade" id="modalFinalizar" tabindex="-1" aria-labelledby="modalFinalizarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalFinalizarLabel">
                    Escolha uma aÃ§Ã£o
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center">
                <p>Deseja apenas finalizar o pedido ou tambÃ©m atualizar o estoque atual?</p>
                <div class="d-flex flex-column gap-2 mt-3">
                    <button id="btnFinalizarPedido" class="btn btn-success w-100">
                        <i class="bi bi-check-circle me-1"></i> Finalizar Pedido
                    </button>
                    <button id="btnAtualizarEstoque" class="btn btn-warning w-100">
                        <i class="bi bi-box-seam me-1"></i> Atualizar Estoque
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="Bootstrap/js/bootstrap.bundle.js"></script>
<script>
    let graficoSemana = null;
    let graficoMes = null;


    // Lista de produtos cujo preÃ§o jÃ¡ Ã© por embalagem
   const produtosPrecoJaEmbalagem = [
    142220, // GRAMPO ROCAMA 106/6
    497924, // FEIXE DE MADEIRA P/ CARTAZ 1M
    145971, // ABRAÃ‡ADEIRA NYLON 10 X 2,5
    145980, // ABRAÃ‡ADEIRA NYLON 15 X 3,4
    571725, // ABRAÃ‡ADEIRA NYLON 30 X 3,6
    434051  // PAPEL CARTAO AMARELO 66X96
];

    // CARREGA PRODUTOS
    function carregarProdutosDoBanco() {
        if (typeof Android === "undefined") return;
        const produtosJson = Android.getProdutosCartazista();
        console.log("produtosJson:", produtosJson);
        let produtos = JSON.parse(produtosJson);

        const listaDiv = document.getElementById('listaProdutos');
        listaDiv.innerHTML = '';

        produtos.forEach(prod => {
            const qtdEmb = Number(prod.qtd_por_embalagem) || 1;
            const precoUnitario = Number(prod.preco) || 0;
            const precoPorEmbalagem = produtosPrecoJaEmbalagem.includes(prod.codigo)
                ? precoUnitario
                : precoUnitario * qtdEmb;

            const div = document.createElement('div');
            div.className = "card mb-2 p-2 shadow-sm";
            div.dataset.precoEmbalagem = precoPorEmbalagem.toFixed(4);
            div.dataset.qtdPorEmbalagem = qtdEmb;

            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${prod.descricao}</strong><br>
                        <small class="codigo">CÃ³digo: ${prod.codigo}</small><br>
                        <small>Embalagem: ${prod.embalagem}</small><br>
                        <small>Qtd por embalagem: ${qtdEmb}</small><br>
                        <small>PreÃ§o unitÃ¡rio: R$ ${precoUnitario.toFixed(2)}</small><br>
                        <small>PreÃ§o por embalagem: R$ ${precoPorEmbalagem.toFixed(2)}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary btn-sm me-1" type="button">-</button>
                        <input type="number" class="form-control form-control-sm text-center me-1" value="0" min="0" style="width: 70px;">
                        <button class="btn btn-outline-secondary btn-sm me-2" type="button">+</button>
                    </div>
                </div>
            `;
            listaDiv.appendChild(div);

            const input = div.querySelector('input');
            const btnMais = div.querySelectorAll('button')[1];
            const btnMenos = div.querySelectorAll('button')[0];

            btnMais.addEventListener('click', () => input.value = parseInt(input.value) + 1);
            btnMenos.addEventListener('click', () => { if (parseInt(input.value) > 0) input.value = parseInt(input.value) - 1; });
        });
    }

    // FINALIZAR PEDIDOS
function finalizarPedidos() {
    const cards = document.querySelectorAll("#listaProdutos .card");
    const produtos = [];

    cards.forEach(card => {
        const input = card.querySelector("input");
        const qtdEmbalagens = parseInt(input.value) || 0;
        if (qtdEmbalagens > 0) {
            const codigo = parseInt(card.querySelector(".codigo").innerText.split(":")[1].trim());
            const qtdPorEmb = parseInt(card.dataset.qtdPorEmbalagem) || 1;
            const precoPorEmbalagem = parseFloat(card.dataset.precoEmbalagem) || 0;
            produtos.push({ codigo, quantidade: qtdEmbalagens, preco: precoPorEmbalagem });
            input.value = 0;
        }
    });

    if (produtos.length > 0) {
        produtos.forEach(p => {
            Android.finalizarPedido(p.codigo, p.quantidade, p.preco); // jÃ¡ atualiza o estoque no Java
        });
    }

    // Atualiza todas as tabelas visuais
    carregarPedidosDaSemana();
    carregarResumoSemanal();
    carregarResumoMensal();
    carregarEstoqueAtual();
}


function carregarEstoqueAtual() {
    if (typeof Android === "undefined") return;

    const raw = Android.getEstoque() || "[]";
    console.log("RAW ESTOQUE:", raw);

    let estoque;
    try {
        estoque = JSON.parse(raw);
    } catch (e) {
        console.error("Erro ao parsear JSON do estoque:", e);
        estoque = [];
    }

    console.log("JSON ESTOQUE PARSEADO:", estoque);

    const tbody = document.querySelector("#tabelaEstoqueAtual tbody");
    tbody.innerHTML = "";

    estoque.forEach(item => {
        console.log("Item do estoque:", item);

        // Cria a linha com data-codigo para poder atualizar depois
        const tr = document.createElement("tr");
        tr.dataset.codigo = item.codigo_produto;

        tr.innerHTML = `
            <td>${item.codigo_produto}</td>
            <td>${item.descricao}</td>
            <td>${item.embalagem ?? "-"}</td>
            <td>${window.__usoRealPorProduto?.[item.codigo_produto] ?? Number(item.quantidade_atual || 0).toFixed(1)}</td>

        `;
        tbody.appendChild(tr);
    });

    if (estoque.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" class="text-center text-muted">Sem dados de estoque</td>`;
        tbody.appendChild(tr);
    }
}

// TABELA SEMANAL
function carregarPedidosDaSemana() {
    if (typeof Android === "undefined") return;

    const pedidos = JSON.parse(Android.getPedidosDaSemana());
    const tbody = document.querySelector("#tabelaEstoque tbody");
    tbody.innerHTML = "";

    let totalSemana = 0;
    let pedidoAtual = null; // id_pedido atual sendo exibido
    let contadorPedido = 0; // contador visual de pedidos na semana

    pedidos.forEach(p => {
        const dataPedido = p.data_pedido; // yyyy-MM-dd
        const codigo = p.codigo_produto;
        const qtdEmb = Number(p.qtd_por_embalagem) || 1;
        const precoUnitarioOriginal = Number(p.preco) || 0;

        const precoPorEmbalagem = precoUnitarioOriginal; // jÃ¡ vem correto do app
        const precoUnitario = precoPorEmbalagem / qtdEmb;

        const precoTotalLinha = precoPorEmbalagem * Number(p.quantidade);
        totalSemana += precoTotalLinha;

        // ðŸ”¹ Cria separador apenas se for um pedido novo
        if (p.id_pedido !== pedidoAtual) {
            pedidoAtual = p.id_pedido;
            contadorPedido++;

            const separador = document.createElement("tr");
            separador.innerHTML = `
                <td colspan="7" class="table-info text-center fw-bold">
                    ðŸ§¾ Pedido ${contadorPedido} - ${dataPedido}
                </td>
            `;
            tbody.appendChild(separador);
        }

        // ðŸ”¹ Linha do produto
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${codigo}</td>
            <td>${p.descricao}</td>
            <td>${p.embalagem ?? '-'}</td>
            <td>${p.quantidade}</td>
            <td>R$ ${precoUnitario.toFixed(2)}</td>
            <td>R$ ${precoTotalLinha.toFixed(2)}</td>
            <td>${dataPedido}</td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById("totalSemana").innerText = "R$ " + totalSemana.toFixed(2);
}

// funÃ§Ã£o para calcular nÃºmero da semana do ano
function getNumeroDaSemana(dataStr) {
    const data = new Date(dataStr);
    const primeiroDiaDoAno = new Date(data.getFullYear(), 0, 1);
    const pastDaysOfYear = (data - primeiroDiaDoAno) / 86400000;
    return Math.ceil((pastDaysOfYear + primeiroDiaDoAno.getDay() + 1) / 7);
}



    // GRÃFICOS
    function carregarResumoSemanal() {
        if (typeof Android === "undefined") return;
        const pedidos = JSON.parse(Android.getPedidosDaSemana());
        const ctx = document.getElementById('graficoSemana').getContext('2d');

        const totaisPorProduto = {};
        pedidos.forEach(p => {
            const codigo = p.codigo_produto || "N/A";
            const qtdEmb = Number(p.qtd_por_embalagem) || 1;
            const quantidade = Number(p.quantidade) || 0;
            const precoUnitario = Number(p.preco) || 0;

            const precoPorEmbalagem = precoUnitario;

            totaisPorProduto[codigo] = (totaisPorProduto[codigo] || 0) + precoPorEmbalagem * quantidade;
        });

        const labels = Object.keys(totaisPorProduto);
        const valores = Object.values(totaisPorProduto);

        if (graficoSemana) graficoSemana.destroy();

        graficoSemana = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Gasto por Produto (R$)', data: valores, backgroundColor: 'rgba(75, 192, 192, 0.7)' }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => "R$ " + ctx.parsed.y.toFixed(2) } }
                },
                scales: { x: { ticks: { font: { size: 8 } } }, y: { beginAtZero: true, ticks: { font: { size: 10 } } } }
            }
        });
    }

    function carregarResumoMensal() {
        if (typeof Android === "undefined") return;
        const pedidos = JSON.parse(Android.getPedidosDoMes());
        const ctx = document.getElementById('graficoMes').getContext('2d');

        const totaisPorDia = {};
        pedidos.forEach(p => {
            const codigo = p.codigo_produto;
            const dia = (p.data_pedido ? p.data_pedido.split(" ")[0] : "Sem data");
            const qtdEmb = Number(p.qtd_por_embalagem) || 1;
            const quantidade = Number(p.quantidade) || 0;
            const precoUnitario = Number(p.preco) || 0;

           const precoPorEmbalagem = precoUnitario;

            totaisPorDia[dia] = (totaisPorDia[dia] || 0) + precoPorEmbalagem * quantidade;
        });

        const labels = Object.keys(totaisPorDia);
        const valores = Object.values(totaisPorDia);

        if (graficoMes) graficoMes.destroy();

        graficoMes = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'Gasto Total DiÃ¡rio (R$)', data: valores, borderColor: 'rgba(255, 99, 132, 0.7)', fill: false, tension: 0.3 }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: ctx => "R$ " + ctx.parsed.y.toFixed(2) } } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // FULLSCREEN SIMPLES DEITADO (toggle)
    function toggleFullscreenDeitado(canvas) {
    const wrapper = canvas.parentElement;
    wrapper.classList.toggle('fullscreen-simulado');

    canvas.style.transform = wrapper.classList.contains('fullscreen-simulado') ? 'rotate(90deg)' : 'rotate(0deg)';

    // BotÃ£o sair dentro do mesmo wrapper
    const btn = wrapper.querySelector('.btn-fullscreen-close');
    if (btn) btn.style.display = wrapper.classList.contains('fullscreen-simulado') ? 'block' : 'none';

    if (graficoSemana && canvas.id === 'graficoSemana') graficoSemana.resize();
    if (graficoMes && canvas.id === 'graficoMes') graficoMes.resize();
}

// BotÃµes de fullscreen
document.getElementById('expandirSemana').addEventListener('click', () => toggleFullscreenDeitado(document.getElementById('graficoSemana')));
document.getElementById('expandirMes').addEventListener('click', () => toggleFullscreenDeitado(document.getElementById('graficoMes')));

// BotÃ£o de fechar
document.querySelectorAll('.btn-fullscreen-close').forEach(btn => {
    btn.addEventListener('click', () => {
        const canvas = btn.parentElement.querySelector('canvas');
        if (canvas) toggleFullscreenDeitado(canvas);
    });
});

// Redesenhar grÃ¡ficos ao mudar fullscreen
['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','MSFullscreenChange'].forEach(evt => {
    document.addEventListener(evt, () => {
        if (graficoSemana) graficoSemana.resize();
        if (graficoMes) graficoMes.resize();
    });
});

function abrirTelaAtualizacaoEstoque() {
    if (typeof Android === "undefined") return;

    const produtosJson = Android.getProdutosCartazista();
    const produtos = JSON.parse(produtosJson);

    let html = `
        <p><b>Por favor, informe a quantidade de cada item que vocÃª tem no estoque hoje:</b></p>
        <div class="d-flex flex-wrap gap-2" style="max-height: 400px; overflow-y: auto;">`;

    produtos.forEach(prod => {
       html += `
<div class="card p-1 shadow-sm" style="flex: 0 0 48%; font-size: 0.7rem;">
    <div>
        <strong>${prod.descricao}</strong><br>
        <small>CÃ³digo: ${prod.codigo}</small><br>
        <small>Embalagem: ${prod.embalagem}</small><br>
        <small>Qtd/embalagem: ${prod.qtd_por_embalagem}</small>
    </div>
    <input type="number" min="0" step="0.1" class="form-control form-control-sm mt-1"
        id="qtd_${prod.codigo}" placeholder="0">
</div>
`;
    });

    html += `</div>
        <button class="btn btn-primary mt-3 w-100" onclick="abrirResumoComparativo()">Continuar</button>`;

    const modalDiv = document.createElement("div");
    modalDiv.className = "modal fade show";
    modalDiv.style.display = "block";
    modalDiv.id = "modalEstoqueAtual";
    modalDiv.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Informar Estoque Atual</h5>
                </div>
                <div class="modal-body">${html}</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Fechar</button>
                </div>
            </div>
        </div>`;

    document.body.appendChild(modalDiv);
}

function abrirResumoComparativo() {
    if (typeof Android === "undefined") return;

    // Captura os valores digitados manualmente
    const estoqueAtualManual = {};
    document.querySelectorAll("input[id^='qtd_']").forEach(input => {
        const codigo = input.id.replace("qtd_", "");
        const valor = parseFloat(input.value) || 0;
        estoqueAtualManual[codigo] = valor;
    });

    // Fecha modal antigo (se existir)
    document.getElementById("modalEstoqueAtual")?.remove();

    // Pega dados do banco
    const estoqueBanco = JSON.parse(Android.getEstoque() || "[]");
    const pedidosBanco = JSON.parse(Android.getPedidosDaSemana() || "[]");

    // Soma total de pedidos da semana por produto
    const pedidosMap = {};
    pedidosBanco.forEach(p => {
        const cod = p.codigo_produto;
        pedidosMap[cod] = (pedidosMap[cod] || 0) + Number(p.quantidade || 0);
    });

    // Adiciona pedidos ainda nÃ£o salvos
    document.querySelectorAll("#listaProdutos .card").forEach(card => {
    const input = card.querySelector("input");
    const qtdEmbalagens = parseInt(input.value) || 0;
    if (qtdEmbalagens > 0) {
        const codigo = parseInt(card.querySelector(".codigo").innerText.split(":")[1].trim());
        const qtdPedidoAtual = qtdEmbalagens; // ðŸ”¹ usa o nÃºmero de embalagens diretamente (1 = 1 pedido)
        pedidosMap[codigo] = qtdPedidoAtual;
    }
});

    // Monta a tabela de resumo
    let html = `<table class="table table-bordered table-sm">
        <thead class="table-light">
            <tr>
                <th>Produto</th>
                <th>Estoque Banco</th>
                <th>Pedido Novo</th>
                <th>Estoque Atual (digitado)</th>
                <th>Uso Real</th>
            </tr>
        </thead>
        <tbody>`;

    let estoqueZerado = true;

    estoqueBanco.forEach(p => {
        const cod = p.codigo_produto;
        const banco = Number(p.quantidade_atual || 0);
        const pedidoNovo = Number(pedidosMap[cod] || 0);
        const atual = Number(estoqueAtualManual[cod] || 0);

        if (banco !== 0 || pedidoNovo !== 0) estoqueZerado = false;

        let usoReal = 0;

// ðŸ”¹ Estoque igual mas hÃ¡ pedido â†’ tudo que pediu foi consumo
if (atual === banco && pedidoNovo > 0) {
    usoReal = pedidoNovo + atual;
}
// ðŸ”¹ Estoque caiu â†’ consumo real
else if (atual < banco) {
    usoReal = ((banco - atual) + pedidoNovo).toFixed(1);
}
else if (atual === 0) {
    usoReal = (atual + pedidoNovo).toFixed(1);
}
// ðŸ”¹ Estoque subiu ou sem alteraÃ§Ã£o â†’ sem consumo
else {
    usoReal = atual + pedidoNovo;
}


        // ðŸ”¹ Estoque final esperado apÃ³s novo pedido
        const estoqueFinal = atual + pedidoNovo;

        html += `<tr>
            <td>${p.descricao}</td>
            <td>${banco}</td>
            <td>${pedidoNovo}</td>
            <td>${atual}</td>
            <td>${usoReal}</td>
        </tr>`;
    });

    if (estoqueZerado) {
        html += `<tr>
            <td colspan="5" class="text-center text-danger">
                AtenÃ§Ã£o! Todo o estoque estava zerado, usamos tudo que tinha ðŸ˜…
            </td>
        </tr>`;
    }

    html += `</tbody></table>
        <button class="btn btn-success mt-3 w-100" onclick="salvarEstoqueFinal()">Salvar Estoques</button>`;

    const modalDiv = document.createElement("div");
    modalDiv.className = "modal fade show";
    modalDiv.style.display = "block";
    modalDiv.id = "modalResumoEstoque";
    modalDiv.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Resumo de AtualizaÃ§Ã£o do Estoque</h5></div>
                <div class="modal-body">${html}</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Fechar</button>
                </div>
            </div>
        </div>`;

    document.body.appendChild(modalDiv);

    // Guarda temporariamente os valores informados
    window.__estoqueAtualInformado = estoqueAtualManual;

    window.__usoRealPorProduto = {};
estoqueBanco.forEach(p => {
    const cod = p.codigo_produto;
    const banco = Number(p.quantidade_atual || 0);
    const pedidoNovo = Number(pedidosMap[cod] || 0);
    const atual = Number(estoqueAtualManual[cod] || 0);

    let usoReal = 0;
    if (atual === banco && pedidoNovo > 0) {
        usoReal = pedidoNovo + atual;
    } else if (atual < banco) {
        usoReal = ((banco - atual) + pedidoNovo).toFixed(1);
    } else if (atual === 0) {
        usoReal = (atual + pedidoNovo).toFixed(1);
    } else {
        usoReal = atual + pedidoNovo;
    }

    window.__usoRealPorProduto[cod] = usoReal; // salva globalmente
});

}




function salvarEstoqueFinal() {
    if (!window.__estoqueAtualInformado) return;

    console.log("ðŸ’¾ Salvando estoque final...");

    // Finaliza pedidos
    finalizarPedidos();

    // Atualiza no banco cada produto usando os valores calculados de uso real
    Object.entries(window.__usoRealPorProduto).forEach(([codigo, usoReal]) => {
        const qtdFinal = Number(usoReal);
        Android.setEstoque(parseInt(codigo), qtdFinal); // envia pro banco
        // Atualiza tabela visual
        const tr = document.querySelector(`#tabelaEstoqueAtual tbody tr[data-codigo='${codigo}']`);
        if (tr) tr.querySelectorAll("td")[3].innerText = qtdFinal.toFixed(1);
        console.log(`âœ… Produto ${codigo}: Estoque atualizado para ${qtdFinal}`);
    });

    alert("Estoque atualizado com sucesso!");
    carregarEstoqueAtual();
    document.getElementById("modalResumoEstoque")?.remove();
}




    // INICIALIZAÃ‡ÃƒO
    document.addEventListener("DOMContentLoaded", () => {
        carregarProdutosDoBanco();
        carregarPedidosDaSemana();
        carregarResumoSemanal();
        carregarResumoMensal();
        carregarEstoqueAtual();

        // FINALIZAR PEDIDOS
    document.getElementById("finalizarPedidos").addEventListener("click", () => {
        const modal = new bootstrap.Modal(document.getElementById("modalFinalizar"));
        modal.show();
    });

    // BotÃ£o "Finalizar Pedido" â€” fluxo atual
    document.getElementById("btnFinalizarPedido").addEventListener("click", () => {
        const modal = bootstrap.Modal.getInstance(document.getElementById("modalFinalizar"));
        modal.hide();
        finalizarPedidos(); // FunÃ§Ã£o separada com o fluxo atual
    });

    // BotÃ£o "Atualizar Estoque" â€” novo fluxo
    document.getElementById("btnAtualizarEstoque").addEventListener("click", () => {
        const modal = bootstrap.Modal.getInstance(document.getElementById("modalFinalizar"));
        modal.hide();
        abrirTelaAtualizacaoEstoque(); // Nova funÃ§Ã£o que vocÃª vai criar
    });
    });
</script>

</body>
</html>

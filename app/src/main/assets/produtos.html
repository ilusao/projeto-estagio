<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o de Produtos</title>
    <link rel="stylesheet" href="Bootstrap/css/bootstrap.css" />
    <link rel="stylesheet" href="Bootstrap/bootstrap-icons.css" />
    <link rel="stylesheet" href="produtos.css" />
    <script src="chart.min.js"></script>
</head>
<body>
<div class="container py-4">
    <h2 class="text-center mb-4">Gest√£o de Produtos</h2>

    <!-- Navega√ß√£o -->
    <ul class="nav nav-tabs" id="tabMenu" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="pedidos-tab" data-bs-toggle="tab" href="#pedidos" role="tab">Pedidos de Produtos</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="estoque-tab" data-bs-toggle="tab" href="#estoque" role="tab">Estoque / Consumo</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="graficos-tab" data-bs-toggle="tab" href="#graficos" role="tab">Relat√≥rios / Gr√°ficos</a>
        </li>
    </ul>

    <!-- Conte√∫do das Abas -->
    <div class="tab-content mt-3">
        <!-- Aba 1: Pedidos -->
        <div class="tab-pane fade show active" id="pedidos" role="tabpanel">
            <h4>Adicionar Pedido de Produto</h4>
            <div id="listaProdutos"></div>
            <button id="finalizarPedidos" class="btn btn-success mt-3">
                <i class="bi bi-check-circle me-1"></i> Finalizar Pedidos
            </button>
        </div>

        <!-- Aba 2: Estoque -->
        <div class="tab-pane fade" id="estoque" role="tabpanel">
            <h4>Estoque / Consumo</h4>
            <table class="table table-bordered table-striped" id="tabelaEstoque">
                <thead class="table-dark">
                <tr>
                    <th>C√≥digo</th>
                    <th>Produto</th>
                    <th>Embalagem</th>
                    <th>Quantidade</th>
                    <th>Pre√ßo Unit√°rio</th>
                    <th>Pre√ßo Total</th>
                    <th>Data</th>
                </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                <tr class="table-secondary fw-bold">
                    <td colspan="5" class="text-end">Total da Semana:</td>
                    <td id="totalSemana">R$ 0,00</td>
                    <td></td>
                </tr>
                </tfoot>
            </table>
        </div>
        <div class="tab-pane fade" id="graficos" role="tabpanel">
            <!-- üìä ABA 3: GR√ÅFICOS -->
            <!-- ABA DE GR√ÅFICOS -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <h5>Resumo da Semana</h5>
                <button id="expandirSemana" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-arrows-fullscreen"></i> Tela cheia
                </button>
            </div>
            <div class="grafico-wrapper position-relative text-center">
                <canvas id="graficoSemana"></canvas>
                <button class="btn btn-sm btn-danger btn-fullscreen-close">‚úï Sair</button>
            </div>


            <div class="d-flex justify-content-between align-items-center mt-4">
                <h5>Resumo do M√™s</h5>
                <button id="expandirMes" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-arrows-fullscreen"></i> Tela cheia
                </button>
            </div>
            <div class="grafico-wrapper position-relative text-center">
                <canvas id="graficoMes"></canvas>
                <button class="btn btn-sm btn-danger btn-fullscreen-close">‚úï Sair</button>
            </div>
        </div>

    </div>
</div>

<script src="Bootstrap/js/bootstrap.bundle.js"></script>
<script>
    let graficoSemana = null;
    let graficoMes = null;


    // Lista de produtos cujo pre√ßo j√° √© por embalagem
   const produtosPrecoJaEmbalagem = [
    142220, // GRAMPO ROCAMA 106/6
    497924, // FEIXE DE MADEIRA P/ CARTAZ 1M
    145971, // ABRA√áADEIRA NYLON 10 X 2,5
    145980, // ABRA√áADEIRA NYLON 15 X 3,4
    571725, // ABRA√áADEIRA NYLON 30 X 3,6
    434051  // PAPEL CARTAO AMARELO 66X96
];

    // CARREGA PRODUTOS
    function carregarProdutosDoBanco() {
        if (typeof Android === "undefined") return;
        const produtosJson = Android.getProdutosCartazista();
        console.log("produtosJson:", produtosJson);
        let produtos = JSON.parse(produtosJson);

        const listaDiv = document.getElementById('listaProdutos');
        listaDiv.innerHTML = '';

        produtos.forEach(prod => {
            const qtdEmb = Number(prod.qtd_por_embalagem) || 1;
            const precoUnitario = Number(prod.preco) || 0;
            const precoPorEmbalagem = produtosPrecoJaEmbalagem.includes(prod.codigo)
                ? precoUnitario
                : precoUnitario * qtdEmb;

            const div = document.createElement('div');
            div.className = "card mb-2 p-2 shadow-sm";
            div.dataset.precoEmbalagem = precoPorEmbalagem.toFixed(4);
            div.dataset.qtdPorEmbalagem = qtdEmb;

            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${prod.descricao}</strong><br>
                        <small class="codigo">C√≥digo: ${prod.codigo}</small><br>
                        <small>Embalagem: ${prod.embalagem}</small><br>
                        <small>Qtd por embalagem: ${qtdEmb}</small><br>
                        <small>Pre√ßo unit√°rio: R$ ${precoUnitario.toFixed(2)}</small><br>
                        <small>Pre√ßo por embalagem: R$ ${precoPorEmbalagem.toFixed(2)}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary btn-sm me-1" type="button">-</button>
                        <input type="number" class="form-control form-control-sm text-center me-1" value="0" min="0" style="width: 70px;">
                        <button class="btn btn-outline-secondary btn-sm me-2" type="button">+</button>
                    </div>
                </div>
            `;
            listaDiv.appendChild(div);

            const input = div.querySelector('input');
            const btnMais = div.querySelectorAll('button')[1];
            const btnMenos = div.querySelectorAll('button')[0];

            btnMais.addEventListener('click', () => input.value = parseInt(input.value) + 1);
            btnMenos.addEventListener('click', () => { if (parseInt(input.value) > 0) input.value = parseInt(input.value) - 1; });
        });
    }

    // FINALIZAR PEDIDOS
   document.getElementById("finalizarPedidos").addEventListener("click", () => {
    const cards = document.querySelectorAll("#listaProdutos .card");
    const produtos = [];

    cards.forEach(card => {
        const input = card.querySelector("input");
        const qtdEmbalagens = parseInt(input.value) || 0;
        if (qtdEmbalagens > 0) {
            const codigo = parseInt(card.querySelector(".codigo").innerText.split(":")[1].trim());
            const qtdPorEmb = parseInt(card.dataset.qtdPorEmbalagem) || 1;
            const precoPorEmbalagem = parseFloat(card.dataset.precoEmbalagem) || 0;

            produtos.push({ codigo, quantidade: qtdEmbalagens, preco: precoPorEmbalagem });
            input.value = 0;
        }
    });

    if (produtos.length > 0) {
    produtos.forEach(p => {
        Android.finalizarPedido(p.codigo, p.quantidade, p.preco);
    });
}

    carregarPedidosDaSemana();
    carregarResumoSemanal();
    carregarResumoMensal();
});


    // TABELA SEMANAL
   function carregarPedidosDaSemana() {
    if (typeof Android === "undefined") return;

    const pedidos = JSON.parse(Android.getPedidosDaSemana());
    const tbody = document.querySelector("#tabelaEstoque tbody");
    tbody.innerHTML = "";

    let totalSemana = 0;
    let pedidoAtual = null; // id_pedido atual sendo exibido
    let contadorPedido = 0; // contador visual de pedidos na semana

    pedidos.forEach(p => {
        const dataPedido = p.data_pedido; // yyyy-MM-dd
        const codigo = p.codigo_produto;
        const qtdEmb = Number(p.qtd_por_embalagem) || 1;
        const precoUnitarioOriginal = Number(p.preco) || 0;

        const precoPorEmbalagem = precoUnitarioOriginal; // j√° vem correto do app
        const precoUnitario = precoPorEmbalagem / qtdEmb;

        const precoTotalLinha = precoPorEmbalagem * Number(p.quantidade);
        totalSemana += precoTotalLinha;

        // üîπ Cria separador apenas se for um pedido novo
        if (p.id_pedido !== pedidoAtual) {
            pedidoAtual = p.id_pedido;
            contadorPedido++;

            const separador = document.createElement("tr");
            separador.innerHTML = `
                <td colspan="7" class="table-info text-center fw-bold">
                    üßæ Pedido ${contadorPedido} - ${dataPedido}
                </td>
            `;
            tbody.appendChild(separador);
        }

        // üîπ Linha do produto
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${codigo}</td>
            <td>${p.descricao}</td>
            <td>${p.embalagem ?? '-'}</td>
            <td>${p.quantidade}</td>
            <td>R$ ${precoUnitario.toFixed(2)}</td>
            <td>R$ ${precoTotalLinha.toFixed(2)}</td>
            <td>${dataPedido}</td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById("totalSemana").innerText = "R$ " + totalSemana.toFixed(2);
}


// fun√ß√£o para calcular n√∫mero da semana do ano
function getNumeroDaSemana(dataStr) {
    const data = new Date(dataStr);
    const primeiroDiaDoAno = new Date(data.getFullYear(), 0, 1);
    const pastDaysOfYear = (data - primeiroDiaDoAno) / 86400000;
    return Math.ceil((pastDaysOfYear + primeiroDiaDoAno.getDay() + 1) / 7);
}


    // GR√ÅFICOS
    function carregarResumoSemanal() {
        if (typeof Android === "undefined") return;
        const pedidos = JSON.parse(Android.getPedidosDaSemana());
        const ctx = document.getElementById('graficoSemana').getContext('2d');

        const totaisPorProduto = {};
        pedidos.forEach(p => {
            const codigo = p.codigo_produto || "N/A";
            const qtdEmb = Number(p.qtd_por_embalagem) || 1;
            const quantidade = Number(p.quantidade) || 0;
            const precoUnitario = Number(p.preco) || 0;

            const precoPorEmbalagem = precoUnitario;

            totaisPorProduto[codigo] = (totaisPorProduto[codigo] || 0) + precoPorEmbalagem * quantidade;
        });

        const labels = Object.keys(totaisPorProduto);
        const valores = Object.values(totaisPorProduto);

        if (graficoSemana) graficoSemana.destroy();

        graficoSemana = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Gasto por Produto (R$)', data: valores, backgroundColor: 'rgba(75, 192, 192, 0.7)' }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => "R$ " + ctx.parsed.y.toFixed(2) } }
                },
                scales: { x: { ticks: { font: { size: 8 } } }, y: { beginAtZero: true, ticks: { font: { size: 10 } } } }
            }
        });
    }

    function carregarResumoMensal() {
        if (typeof Android === "undefined") return;
        const pedidos = JSON.parse(Android.getPedidosDoMes());
        const ctx = document.getElementById('graficoMes').getContext('2d');

        const totaisPorDia = {};
        pedidos.forEach(p => {
            const codigo = p.codigo_produto;
            const dia = (p.data_pedido ? p.data_pedido.split(" ")[0] : "Sem data");
            const qtdEmb = Number(p.qtd_por_embalagem) || 1;
            const quantidade = Number(p.quantidade) || 0;
            const precoUnitario = Number(p.preco) || 0;

           const precoPorEmbalagem = precoUnitario;

            totaisPorDia[dia] = (totaisPorDia[dia] || 0) + precoPorEmbalagem * quantidade;
        });

        const labels = Object.keys(totaisPorDia);
        const valores = Object.values(totaisPorDia);

        if (graficoMes) graficoMes.destroy();

        graficoMes = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'Gasto Total Di√°rio (R$)', data: valores, borderColor: 'rgba(255, 99, 132, 0.7)', fill: false, tension: 0.3 }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: ctx => "R$ " + ctx.parsed.y.toFixed(2) } } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // FULLSCREEN SIMPLES DEITADO (toggle)
    function toggleFullscreenDeitado(canvas) {
    const wrapper = canvas.parentElement;
    wrapper.classList.toggle('fullscreen-simulado');

    canvas.style.transform = wrapper.classList.contains('fullscreen-simulado') ? 'rotate(90deg)' : 'rotate(0deg)';

    // Bot√£o sair dentro do mesmo wrapper
    const btn = wrapper.querySelector('.btn-fullscreen-close');
    if (btn) btn.style.display = wrapper.classList.contains('fullscreen-simulado') ? 'block' : 'none';

    if (graficoSemana && canvas.id === 'graficoSemana') graficoSemana.resize();
    if (graficoMes && canvas.id === 'graficoMes') graficoMes.resize();
}

// Bot√µes de fullscreen
document.getElementById('expandirSemana').addEventListener('click', () => toggleFullscreenDeitado(document.getElementById('graficoSemana')));
document.getElementById('expandirMes').addEventListener('click', () => toggleFullscreenDeitado(document.getElementById('graficoMes')));

// Bot√£o de fechar
document.querySelectorAll('.btn-fullscreen-close').forEach(btn => {
    btn.addEventListener('click', () => {
        const canvas = btn.parentElement.querySelector('canvas');
        if (canvas) toggleFullscreenDeitado(canvas);
    });
});

// Redesenhar gr√°ficos ao mudar fullscreen
['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','MSFullscreenChange'].forEach(evt => {
    document.addEventListener(evt, () => {
        if (graficoSemana) graficoSemana.resize();
        if (graficoMes) graficoMes.resize();
    });
});


    // INICIALIZA√á√ÉO
    document.addEventListener("DOMContentLoaded", () => {
        carregarProdutosDoBanco();
        carregarPedidosDaSemana();
        carregarResumoSemanal();
        carregarResumoMensal();
    });
</script>

</body>
</html>

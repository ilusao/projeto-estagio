<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gestão de Produtos</title>
    <link rel="stylesheet" href="Bootstrap/css/bootstrap.css" />
    <link rel="stylesheet" href="Bootstrap/bootstrap-icons.css" />
    <link rel="stylesheet" href="produtos.css" />
    <script src="chart.min.js"></script>
</head>
<body>
<div class="container py-4">
    <h2 class="text-center mb-4">Gestão de Produtos</h2>

    <!-- Navegação -->
    <ul class="nav nav-tabs" id="tabMenu" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="pedidos-tab" data-bs-toggle="tab" href="#pedidos" role="tab">Pedidos de Produtos</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="estoque-tab" data-bs-toggle="tab" href="#estoque" role="tab">Estoque / Consumo</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="graficos-tab" data-bs-toggle="tab" href="#graficos" role="tab">Relatórios / Gráficos</a>
        </li>
    </ul>

    <!-- Conteúdo das Abas -->
    <div class="tab-content mt-3">
        <!-- Aba 1: Pedidos -->
        <div class="tab-pane fade show active" id="pedidos" role="tabpanel">
            <h4>Adicionar Pedido de Produto</h4>
            <div id="listaProdutos">
                <!-- Os produtos serão inseridos pelo JS -->
            </div>
            <button id="finalizarPedidos" class="btn btn-success mt-3">
                <i class="bi bi-check-circle me-1"></i> Finalizar Pedidos
            </button>
        </div>

        <!-- Aba 2: Estoque -->
        <div class="tab-pane fade" id="estoque" role="tabpanel">
            <h4>Estoque / Consumo</h4>
            <table class="table table-bordered table-striped" id="tabelaEstoque">
                <thead class="table-dark">
                <tr>
                    <th>Produto</th>
                    <th>Quantidade</th>
                    <th>Data</th>
                </tr>
                </thead>
                <tbody>
                <!-- Os pedidos serão inseridos pelo JS -->
                </tbody>
            </table>
        </div>

        <!-- Aba 3: Gráficos -->
        <div class="tab-pane fade" id="graficos" role="tabpanel">
            <h4>Relatórios / Gasto Mensal</h4>
            <canvas id="graficoMes" width="400" height="200"></canvas>
        </div>
    </div>
</div>

<script src="Bootstrap/js/bootstrap.bundle.js"></script>
<script>
    function carregarProdutosDoBanco() {
        if (typeof Android === "undefined") {
            console.error("Android não está definido!");
            return;
        }

        const produtosJson = Android.getProdutosCartazista();
        console.log("JSON recebido do Android:", produtosJson);

        let produtos;
        try {
            produtos = JSON.parse(produtosJson);
        } catch (e) {
            console.error("Erro ao parsear JSON:", e);
            return;
        }

        const listaDiv = document.getElementById('listaProdutos');
        listaDiv.innerHTML = ''; // limpar

        produtos.forEach(prod => {
            const div = document.createElement('div');
            div.className = "card mb-2 p-2 shadow-sm";

            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${prod.descricao}</strong><br>
                        <small class="codigo">Código: ${prod.codigo}</small><br>
                        <small>Embalagem: ${prod.embalagem}</small><br>
                        <small>Preço unitário: R$ ${prod.preco.toFixed(2)}</small>
                        <small class="preco">Preço unitário: R$ ${prod.preco.toFixed(2)}</small>
                        <small>Qtd por embalagem: ${prod.qtd_por_embalagem}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary btn-sm me-1" type="button">-</button>
                        <input type="number" class="form-control form-control-sm text-center me-1" value="0" min="0" style="width: 70px;">
                        <button class="btn btn-outline-secondary btn-sm me-2" type="button">+</button>
                    </div>
                </div>
            `;

            listaDiv.appendChild(div);

            const input = div.querySelector('input');
            const btnMais = div.querySelectorAll('button')[1];
            const btnMenos = div.querySelectorAll('button')[0];

            btnMais.addEventListener('click', () => { input.value = parseInt(input.value) + 1; });
            btnMenos.addEventListener('click', () => { if(parseInt(input.value) > 0) input.value = parseInt(input.value) - 1; });
        });
    }

    function carregarPedidosDaSemana() {
    if(typeof Android === "undefined") return;

    let pedidos = JSON.parse(Android.getPedidosDaSemana());
    let tbody = document.querySelector("#tabelaEstoque tbody");
    tbody.innerHTML = "";

    pedidos.forEach(p => {
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${p.descricao}</td><td>${p.quantidade}</td><td>${p.data_pedido}</td>`;
        tbody.appendChild(tr);
    });
}

function carregarResumoMensal() {
    if(typeof Android === "undefined") return;

    let pedidos = JSON.parse(Android.getPedidosDoMes());
    let ctx = document.getElementById('graficoMes').getContext('2d');

    let labels = pedidos.map(p => `Semana ${p.semana}: ${p.descricao}`);
    let data = pedidos.map(p => p.quantidade_total);

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Quantidade Mensal por Semana',
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.7)'
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });
}

document.addEventListener("DOMContentLoaded", () => {
    carregarProdutosDoBanco();
    carregarPedidosDaSemana();
    carregarResumoMensal();
});

document.getElementById("finalizarPedidos").addEventListener("click", () => {
    const cards = document.querySelectorAll("#listaProdutos .card");
    console.log("Finalizando pedidos...");

    cards.forEach(card => {
        const input = card.querySelector("input");
        const quantidade = parseInt(input.value);
        if (quantidade > 0) {
            const codigo = parseInt(card.querySelector(".codigo").innerText.split(":")[1].trim());
            const precoUnitario = parseFloat(card.querySelector(".preco").innerText.split("R$")[1]);
            const precoTotal = precoUnitario * quantidade;

            console.log(`Chamando Android.finalizarPedido -> codigo: ${codigo}, quantidade: ${quantidade}, precoTotal: ${precoTotal}`);

            Android.finalizarPedido(codigo, quantidade, precoTotal);

            input.value = 0; // resetar
        }
    });

    console.log("Pedidos finalizados. Atualizando tabela...");
    carregarPedidosDaSemana(); // atualizar tabela Estoque
});

    // Chama assim que a página carregar
    document.addEventListener("DOMContentLoaded", carregarProdutosDoBanco);
</script>

</body>
</html>

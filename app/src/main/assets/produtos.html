<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gest√£o de Produtos</title>
    <link rel="stylesheet" href="Bootstrap/css/bootstrap.css" />
    <link rel="stylesheet" href="Bootstrap/bootstrap-icons.css" />
    <link rel="stylesheet" href="produtos.css" />
    <script src="chart.min.js"></script>
</head>
<body>
<div class="container py-4">
    <h2 class="text-center mb-4">Gest√£o de Produtos</h2>

    <!-- Navega√ß√£o -->
    <ul class="nav nav-tabs" id="tabMenu" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="pedidos-tab" data-bs-toggle="tab" href="#pedidos" role="tab">Pedidos de Produtos</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="estoque-tab" data-bs-toggle="tab" href="#estoque" role="tab">Estoque / Consumo</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="graficos-tab" data-bs-toggle="tab" href="#graficos" role="tab">Relat√≥rios / Gr√°ficos</a>
        </li>
    </ul>

    <!-- Conte√∫do das Abas -->
    <div class="tab-content mt-3">
        <!-- Aba 1: Pedidos -->
        <div class="tab-pane fade show active" id="pedidos" role="tabpanel">
            <h4>Adicionar Pedido de Produto</h4>
            <div id="listaProdutos"></div>
            <button id="finalizarPedidos" class="btn btn-success mt-3">
                <i class="bi bi-check-circle me-1"></i> Finalizar Pedidos
            </button>
        </div>

        <!-- Aba 2: Estoque -->
        <div class="tab-pane fade" id="estoque" role="tabpanel">
            <h4>Estoque / Consumo</h4>

            <h5>üì¶ Estoque Atual</h5>
            <table class="table table-bordered table-striped table-sm" id="tabelaEstoqueAtual">
                <thead class="table-dark">
                <tr>
                    <th>C√≥digo</th>
                    <th>Produto</th>
                    <th>Embalagem</th>
                    <th>Qtd Atual</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>


            <table class="table table-bordered table-striped" id="tabelaEstoque">
                <thead class="table-dark">
                <tr>
                    <th>C√≥digo</th>
                    <th>Produto</th>
                    <th>Embalagem</th>
                    <th>Quantidade</th>
                    <th>Pre√ßo Unit√°rio</th>
                    <th>Pre√ßo Total</th>
                    <th>Data</th>
                </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                <tr class="table-secondary fw-bold">
                    <td colspan="5" class="text-end">Total da Semana:</td>
                    <td id="totalSemana">R$ 0,00</td>
                    <td></td>
                </tr>
                </tfoot>
            </table>
        </div>
        <div class="tab-pane fade" id="graficos" role="tabpanel">
            <!-- üìä ABA 3: GR√ÅFICOS -->
            <!-- ABA DE GR√ÅFICOS -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <h5>Resumo da Semana</h5>
                <button id="expandirSemana" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-arrows-fullscreen"></i> Tela cheia
                </button>
            </div>
            <div class="grafico-wrapper position-relative text-center">
                <canvas id="graficoSemana"></canvas>
                <button class="btn btn-sm btn-danger btn-fullscreen-close">‚úï Sair</button>
            </div>


            <div class="d-flex justify-content-between align-items-center mt-4">
                <h5>Resumo do M√™s</h5>
                <button id="expandirMes" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-arrows-fullscreen"></i> Tela cheia
                </button>
            </div>
            <div class="grafico-wrapper position-relative text-center">
                <canvas id="graficoMes"></canvas>
                <button class="btn btn-sm btn-danger btn-fullscreen-close">‚úï Sair</button>
            </div>

            <h3>Gr√°fico de Uso dos Produtos</h3>
            <canvas id="graficoUsoProdutos"></canvas>
        </div>

    </div>
</div>

<!-- MODAL DE OP√á√ïES -->
<div class="modal fade" id="modalFinalizar" tabindex="-1" aria-labelledby="modalFinalizarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalFinalizarLabel">
                    Escolha uma a√ß√£o
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center">
                <p>Deseja apenas finalizar o pedido ou tamb√©m atualizar o estoque atual?</p>
                <div class="d-flex flex-column gap-2 mt-3">
                    <button id="btnFinalizarPedido" class="btn btn-success w-100">
                        <i class="bi bi-check-circle me-1"></i> Finalizar Pedido
                    </button>
                    <button id="btnAtualizarEstoque" class="btn btn-warning w-100">
                        <i class="bi bi-box-seam me-1"></i> Atualizar Estoque
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="Bootstrap/js/bootstrap.bundle.js"></script>
<script>
    let graficoSemana = null;
    let graficoMes = null;


    // Lista de produtos cujo pre√ßo j√° √© por embalagem
   const produtosPrecoJaEmbalagem = [
    142220, // GRAMPO ROCAMA 106/6
    497924, // FEIXE DE MADEIRA P/ CARTAZ 1M
    145971, // ABRA√áADEIRA NYLON 10 X 2,5
    145980, // ABRA√áADEIRA NYLON 15 X 3,4
    571725, // ABRA√áADEIRA NYLON 30 X 3,6
    434051  // PAPEL CARTAO AMARELO 66X96
];

    // CARREGA PRODUTOS
    function carregarProdutosDoBanco() {
        if (typeof Android === "undefined") return;
        const produtosJson = Android.getProdutosCartazista();
        console.log("produtosJson:", produtosJson);
        let produtos = JSON.parse(produtosJson);

        const listaDiv = document.getElementById('listaProdutos');
        listaDiv.innerHTML = '';

        produtos.forEach(prod => {
            const qtdEmb = Number(prod.qtd_por_embalagem) || 1;
            const precoUnitario = Number(prod.preco) || 0;
            const precoPorEmbalagem = produtosPrecoJaEmbalagem.includes(prod.codigo)
                ? precoUnitario
                : precoUnitario * qtdEmb;

            const div = document.createElement('div');
            div.className = "card mb-2 p-2 shadow-sm";
            div.dataset.precoEmbalagem = precoPorEmbalagem.toFixed(4);
            div.dataset.qtdPorEmbalagem = qtdEmb;

            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${prod.descricao}</strong><br>
                        <small class="codigo">C√≥digo: ${prod.codigo}</small><br>
                        <small>Embalagem: ${prod.embalagem}</small><br>
                        <small>Qtd por embalagem: ${qtdEmb}</small><br>
                        <small>Pre√ßo unit√°rio: R$ ${precoUnitario.toFixed(2)}</small><br>
                        <small>Pre√ßo por embalagem: R$ ${precoPorEmbalagem.toFixed(2)}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-outline-secondary btn-sm me-1" type="button">-</button>
                        <input type="number" class="form-control form-control-sm text-center me-1" value="0" min="0" style="width: 70px;">
                        <button class="btn btn-outline-secondary btn-sm me-2" type="button">+</button>
                    </div>
                </div>
            `;
            listaDiv.appendChild(div);

            const input = div.querySelector('input');
            const btnMais = div.querySelectorAll('button')[1];
            const btnMenos = div.querySelectorAll('button')[0];

            btnMais.addEventListener('click', () => input.value = parseInt(input.value) + 1);
            btnMenos.addEventListener('click', () => { if (parseInt(input.value) > 0) input.value = parseInt(input.value) - 1; });
        });
    }

    // FINALIZAR PEDIDOS
function finalizarPedidos() {
    const cards = document.querySelectorAll("#listaProdutos .card");
    const produtos = [];

    cards.forEach(card => {
        const input = card.querySelector("input");
        const qtdEmbalagens = parseInt(input.value) || 0;
        if (qtdEmbalagens > 0) {
            const codigo = parseInt(card.querySelector(".codigo").innerText.split(":")[1].trim());
            const qtdPorEmb = parseInt(card.dataset.qtdPorEmbalagem) || 1;
            const precoPorEmbalagem = parseFloat(card.dataset.precoEmbalagem) || 0;
            produtos.push({ codigo, quantidade: qtdEmbalagens, preco: precoPorEmbalagem });
            input.value = 0;
        }
    });

    if (produtos.length > 0) {
        produtos.forEach(p => {
        console.log("Finalizando pedido:", p);
            Android.finalizarPedido(p.codigo, p.quantidade, p.preco); // j√° atualiza o estoque no Java
        });
    }

    // Atualiza todas as tabelas visuais
    carregarPedidosDaSemana();
    carregarResumoSemanal();
    carregarResumoMensal();
    carregarEstoqueAtual();
}


function carregarEstoqueAtual() {
    if (typeof Android === "undefined") return;

    const raw = Android.getEstoque() || "[]";
    console.log("RAW ESTOQUE:", raw);

    let estoque;
    try {
        estoque = JSON.parse(raw);
    } catch (e) {
        console.error("Erro ao parsear JSON do estoque:", e);
        estoque = [];
    }

    console.log("JSON ESTOQUE PARSEADO:", estoque);

    const tbody = document.querySelector("#tabelaEstoqueAtual tbody");
    tbody.innerHTML = "";

    estoque.forEach(item => {
        console.log("Item do estoque:", item);

        // Cria a linha com data-codigo para poder atualizar depois
        const tr = document.createElement("tr");
        tr.dataset.codigo = item.codigo_produto;

        tr.innerHTML = `
            <td>${item.codigo_produto}</td>
            <td>${item.descricao}</td>
            <td>${item.embalagem ?? "-"}</td>
            <td>${window.__usoRealPorProduto?.[item.codigo_produto] ?? Number(item.quantidade_atual || 0).toFixed(1)}</td>

        `;
        tbody.appendChild(tr);
    });

    if (estoque.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" class="text-center text-muted">Sem dados de estoque</td>`;
        tbody.appendChild(tr);
    }
}

// TABELA SEMANAL
function carregarPedidosDaSemana() {
    if (typeof Android === "undefined") return;

    const pedidos = JSON.parse(Android.getPedidosDaSemana());
    const tbody = document.querySelector("#tabelaEstoque tbody");
    tbody.innerHTML = "";

    let totalSemana = 0;
    let pedidoAtual = null; // id_pedido atual sendo exibido
    let contadorPedido = 0; // contador visual de pedidos na semana

    pedidos.forEach(p => {
        const dataPedido = p.data_pedido; // yyyy-MM-dd
        const codigo = p.codigo_produto;
        const qtdEmb = Number(p.qtd_por_embalagem) || 1;
        const precoUnitarioOriginal = Number(p.preco) || 0;

        const precoPorEmbalagem = precoUnitarioOriginal; // j√° vem correto do app
        const precoUnitario = precoPorEmbalagem / qtdEmb;

        const precoTotalLinha = precoPorEmbalagem * Number(p.quantidade);
        totalSemana += precoTotalLinha;

        // üîπ Cria separador apenas se for um pedido novo
        if (p.id_pedido !== pedidoAtual) {
            pedidoAtual = p.id_pedido;
            contadorPedido++;

            const separador = document.createElement("tr");
            separador.innerHTML = `
                <td colspan="7" class="table-info text-center fw-bold">
                    üßæ Pedido ${contadorPedido} - ${dataPedido}
                </td>
            `;
            tbody.appendChild(separador);
        }

        // üîπ Linha do produto
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${codigo}</td>
            <td>${p.descricao}</td>
            <td>${p.embalagem ?? '-'}</td>
            <td>${p.quantidade}</td>
            <td>R$ ${precoUnitario.toFixed(2)}</td>
            <td>R$ ${precoTotalLinha.toFixed(2)}</td>
            <td>${dataPedido}</td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById("totalSemana").innerText = "R$ " + totalSemana.toFixed(2);
}

// fun√ß√£o para calcular n√∫mero da semana do ano
function getNumeroDaSemana(dataStr) {
    const data = new Date(dataStr);
    const primeiroDiaDoAno = new Date(data.getFullYear(), 0, 1);
    const pastDaysOfYear = (data - primeiroDiaDoAno) / 86400000;
    return Math.ceil((pastDaysOfYear + primeiroDiaDoAno.getDay() + 1) / 7);
}



    // GR√ÅFICOS
    function carregarResumoSemanal() {
        if (typeof Android === "undefined") return;
        const pedidos = JSON.parse(Android.getPedidosDaSemana());
        const ctx = document.getElementById('graficoSemana').getContext('2d');

        const totaisPorProduto = {};
        pedidos.forEach(p => {
            const codigo = p.codigo_produto || "N/A";
            const qtdEmb = Number(p.qtd_por_embalagem) || 1;
            const quantidade = Number(p.quantidade) || 0;
            const precoUnitario = Number(p.preco) || 0;

            const precoPorEmbalagem = precoUnitario;

            totaisPorProduto[codigo] = (totaisPorProduto[codigo] || 0) + precoPorEmbalagem * quantidade;
        });

        const labels = Object.keys(totaisPorProduto);
        const valores = Object.values(totaisPorProduto);

        if (graficoSemana) graficoSemana.destroy();

        graficoSemana = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Gasto por Produto (R$)', data: valores, backgroundColor: 'rgba(75, 192, 192, 0.7)' }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => "R$ " + ctx.parsed.y.toFixed(2) } }
                },
                scales: { x: { ticks: { font: { size: 8 } } }, y: { beginAtZero: true, ticks: { font: { size: 10 } } } }
            }
        });
    }

    function carregarResumoMensal() {
        if (typeof Android === "undefined") return;
        const pedidos = JSON.parse(Android.getPedidosDoMes());
        const ctx = document.getElementById('graficoMes').getContext('2d');

        const totaisPorDia = {};
        pedidos.forEach(p => {
            const codigo = p.codigo_produto;
            const dia = (p.data_pedido ? p.data_pedido.split(" ")[0] : "Sem data");
            const qtdEmb = Number(p.qtd_por_embalagem) || 1;
            const quantidade = Number(p.quantidade) || 0;
            const precoUnitario = Number(p.preco) || 0;

           const precoPorEmbalagem = precoUnitario;

            totaisPorDia[dia] = (totaisPorDia[dia] || 0) + precoPorEmbalagem * quantidade;
        });

        const labels = Object.keys(totaisPorDia);
        const valores = Object.values(totaisPorDia);

        if (graficoMes) graficoMes.destroy();

        graficoMes = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'Gasto Total Di√°rio (R$)', data: valores, borderColor: 'rgba(255, 99, 132, 0.7)', fill: false, tension: 0.3 }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: ctx => "R$ " + ctx.parsed.y.toFixed(2) } } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // FULLSCREEN SIMPLES DEITADO (toggle)
    function toggleFullscreenDeitado(canvas) {
    const wrapper = canvas.parentElement;
    wrapper.classList.toggle('fullscreen-simulado');

    canvas.style.transform = wrapper.classList.contains('fullscreen-simulado') ? 'rotate(90deg)' : 'rotate(0deg)';

    // Bot√£o sair dentro do mesmo wrapper
    const btn = wrapper.querySelector('.btn-fullscreen-close');
    if (btn) btn.style.display = wrapper.classList.contains('fullscreen-simulado') ? 'block' : 'none';

    if (graficoSemana && canvas.id === 'graficoSemana') graficoSemana.resize();
    if (graficoMes && canvas.id === 'graficoMes') graficoMes.resize();
}

// Bot√µes de fullscreen
document.getElementById('expandirSemana').addEventListener('click', () => toggleFullscreenDeitado(document.getElementById('graficoSemana')));
document.getElementById('expandirMes').addEventListener('click', () => toggleFullscreenDeitado(document.getElementById('graficoMes')));

// Bot√£o de fechar
document.querySelectorAll('.btn-fullscreen-close').forEach(btn => {
    btn.addEventListener('click', () => {
        const canvas = btn.parentElement.querySelector('canvas');
        if (canvas) toggleFullscreenDeitado(canvas);
    });
});

// Redesenhar gr√°ficos ao mudar fullscreen
['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','MSFullscreenChange'].forEach(evt => {
    document.addEventListener(evt, () => {
        if (graficoSemana) graficoSemana.resize();
        if (graficoMes) graficoMes.resize();
    });
});

function abrirTelaAtualizacaoEstoque() {
    if (typeof Android === "undefined") return;

    const produtosJson = Android.getProdutosCartazista();
    const produtos = JSON.parse(produtosJson);

    let html = `
        <p><b>Por favor, informe a quantidade de cada item que voc√™ tem no estoque hoje:</b></p>
        <div class="d-flex flex-wrap gap-2" style="max-height: 400px; overflow-y: auto;">`;

    produtos.forEach(prod => {
       html += `
<div class="card p-1 shadow-sm" style="flex: 0 0 48%; font-size: 0.7rem;">
    <div>
        <strong>${prod.descricao}</strong><br>
        <small>C√≥digo: ${prod.codigo}</small><br>
        <small>Embalagem: ${prod.embalagem}</small><br>
        <small>Qtd/embalagem: ${prod.qtd_por_embalagem}</small>
    </div>
    <input type="number" min="0" step="0.1" class="form-control form-control-sm mt-1"
        id="qtd_${prod.codigo}" placeholder="0">
</div>
`;
    });

    html += `</div>
        <button class="btn btn-primary mt-3 w-100" onclick="abrirResumoComparativo()">Continuar</button>`;

    const modalDiv = document.createElement("div");
    modalDiv.className = "modal fade show";
    modalDiv.style.display = "block";
    modalDiv.id = "modalEstoqueAtual";
    modalDiv.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Informar Estoque Atual</h5>
                </div>
                <div class="modal-body">${html}</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Fechar</button>
                </div>
            </div>
        </div>`;

    document.body.appendChild(modalDiv);
}

function abrirResumoComparativo() {
    if (typeof Android === "undefined") return;

    // Captura os valores digitados manualmente
    const estoqueAtualManual = {};
    document.querySelectorAll("input[id^='qtd_']").forEach(input => {
        const codigo = input.id.replace("qtd_", "");
        const valor = parseFloat(input.value) || 0;
        estoqueAtualManual[codigo] = valor;
    });

    // Fecha modal antigo (se existir)
    document.getElementById("modalEstoqueAtual")?.remove();

    // Pega dados do banco
    const estoqueBanco = JSON.parse(Android.getEstoque() || "[]");
    const pedidosBanco = JSON.parse(Android.getPedidosDaSemana() || "[]");

    // Cria mapa apenas do pedido que acabou de ser digitado (pedido novo)
    const pedidoAtualMap = {};
    document.querySelectorAll("#listaProdutos .card").forEach(card => {
        const input = card.querySelector("input");
        const qtdEmbalagens = parseInt(input.value) || 0;
        if (qtdEmbalagens > 0) {
            const codigo = parseInt(card.querySelector(".codigo").innerText.split(":")[1].trim());
            pedidoAtualMap[codigo] = qtdEmbalagens; // somente o pedido novo
        }
    });

    // Monta a tabela de resumo
    let html = `<table class="table table-bordered table-sm">
        <thead class="table-light">
            <tr>
                <th>Produto</th>
                <th>Estoque Banco</th>
                <th>Pedido Novo</th>
                <th>Estoque Atual (digitado)</th>
                <th>Uso Real</th>
            </tr>
        </thead>
        <tbody>`;

    let estoqueZerado = true;
    const usoRealPorProduto = {};
    const usoRealConsumoPorProduto = {};

    estoqueBanco.forEach(p => {
        const cod = p.codigo_produto;
        const banco = Number(p.quantidade_atual || 0);
        const pedidoNovo = Number(pedidoAtualMap[cod] || 0); // üîπ apenas pedido novo
        const atual = Number(estoqueAtualManual[cod] || 0);

        if (banco !== 0 || pedidoNovo !== 0) estoqueZerado = false;

        // C√°lculo do uso real
        let usoReal = 0;
         if (atual === 0) {
            usoReal = pedidoNovo;
        }  else {
            usoReal = atual + pedidoNovo;
        }

        usoRealPorProduto[cod] = usoReal;

        // Consumo real: quanto realmente foi usado desde o √∫ltimo pedido
        let usoRealConsumo = 0;
        if (banco > 0 && atual >= 0 && atual < banco) {
            usoRealConsumo = (banco - atual).toFixed(1);
        } else {
            usoRealConsumo = 0;
        }
        usoRealConsumoPorProduto[cod] = usoRealConsumo;

        // Monta a linha da tabela
        html += `<tr>
            <td>${p.descricao}</td>
            <td>${banco}</td>
            <td>${pedidoNovo}</td>
            <td>${atual}</td>
            <td>${usoReal}</td>
        </tr>`;
    });

    if (estoqueZerado) {
        html += `<tr>
            <td colspan="5" class="text-center text-danger">
                Aten√ß√£o! Todo o estoque estava zerado, usamos tudo que tinha üòÖ
            </td>
        </tr>`;
    }

    html += `</tbody></table>
        <button class="btn btn-success mt-3 w-100" onclick="salvarEstoqueFinal()">Salvar Estoques</button>`;

    const modalDiv = document.createElement("div");
    modalDiv.className = "modal fade show";
    modalDiv.style.display = "block";
    modalDiv.id = "modalResumoEstoque";
    modalDiv.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Resumo de Atualiza√ß√£o do Estoque</h5></div>
                <div class="modal-body">${html}</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Fechar</button>
                </div>
            </div>
        </div>`;

    document.body.appendChild(modalDiv);

    // Guarda temporariamente os valores informados
    window.__estoqueAtualInformado = estoqueAtualManual;
    window.__usoRealPorProduto = usoRealPorProduto;
    window.__usoRealConsumoPorProduto = usoRealConsumoPorProduto;

    // Mostra aviso de consumo real
    let mensagemUso = "üì¶ Consumo registrado desde o √∫ltimo pedido:\n\n";
    let totalGeral = 0;

    estoqueBanco.forEach(p => {
        const cod = p.codigo_produto;
        const uso = parseFloat(usoRealConsumoPorProduto[cod] || 0);
        if (uso > 0) {
            mensagemUso += `‚Ä¢ ${p.descricao}: ${uso}\n`;
            totalGeral += uso;
        }
    });

    if (totalGeral > 0) {
        mensagemUso += `\nüî∏ Total geral de produtos usados: ${totalGeral}`;
        alert(mensagemUso);
    } else {
        alert("Nenhum produto foi consumido desde o √∫ltimo pedido.");
    }
}





function salvarEstoqueFinal() {
    if (!window.__estoqueAtualInformado) return;

    console.log("üíæ Salvando estoque final...");

    // Finaliza pedidos
    finalizarPedidos();

    // Atualiza no banco cada produto usando os valores calculados de uso real
    Object.entries(window.__usoRealPorProduto).forEach(([codigo, usoReal]) => {
        const qtdFinal = Number(usoReal);
        Android.setEstoque(parseInt(codigo), qtdFinal); // envia pro banco
        // Atualiza tabela visual
        const tr = document.querySelector(`#tabelaEstoqueAtual tbody tr[data-codigo='${codigo}']`);
        if (tr) tr.querySelectorAll("td")[3].innerText = qtdFinal.toFixed(1);
        console.log(`‚úÖ Produto ${codigo}: Estoque atualizado para ${qtdFinal}`);
    });

    carregarGraficoUsoProdutos();

    alert("Estoque atualizado com sucesso!");
    carregarEstoqueAtual();
    document.getElementById("modalResumoEstoque")?.remove();
}




    // INICIALIZA√á√ÉO
    document.addEventListener("DOMContentLoaded", () => {
        carregarProdutosDoBanco();
        carregarPedidosDaSemana();
        carregarResumoSemanal();
        carregarResumoMensal();
        carregarEstoqueAtual();

        // FINALIZAR PEDIDOS
    document.getElementById("finalizarPedidos").addEventListener("click", () => {
        const modal = new bootstrap.Modal(document.getElementById("modalFinalizar"));
        modal.show();
    });

    // Bot√£o "Finalizar Pedido" ‚Äî fluxo atual
    document.getElementById("btnFinalizarPedido").addEventListener("click", () => {
        const modal = bootstrap.Modal.getInstance(document.getElementById("modalFinalizar"));
        modal.hide();
        finalizarPedidos(); // Fun√ß√£o separada com o fluxo atual
    });

    // Bot√£o "Atualizar Estoque" ‚Äî novo fluxo
    document.getElementById("btnAtualizarEstoque").addEventListener("click", () => {
        const modal = bootstrap.Modal.getInstance(document.getElementById("modalFinalizar"));
        modal.hide();
        abrirTelaAtualizacaoEstoque(); // Nova fun√ß√£o que voc√™ vai criar
    });
    });

// üîπ Fun√ß√£o para carregar os dados de uso e atualizar o gr√°fico
// Fun√ß√£o para carregar os dados de uso e atualizar o gr√°fico
function carregarGraficoUsoProdutos() {
    if (typeof Android === "undefined") return;

    console.log("üìä Solicitando dados de uso dos produtos...");
    const dadosJSON = Android.getDadosUsoProdutos();
    let dados = [];

    try {
        dados = JSON.parse(dadosJSON);
        console.log(`üì¶ Dados recebidos: ${dados.length} itens`);
    } catch (e) {
        console.error("‚ùå Erro ao parsear JSON de uso dos produtos:", e);
        return;
    }

    // Aguarda o layout carregar antes de desenhar o gr√°fico
    setTimeout(() => {
        atualizarGraficoUso(dados);
    }, 500); // meio segundo ‚Äî tempo suficiente pra tela estabilizar
}

// Chama automaticamente ao carregar toda a p√°gina
window.addEventListener("load", () => {
    console.log("üåê P√°gina carregada ‚Äî iniciando gr√°fico de uso...");
    carregarGraficoUsoProdutos();
});

function atualizarGraficoUso(dados) {
    console.log("üé® Criando novo gr√°fico...");

    const canvas = document.getElementById('graficoUsoProdutos');
    if (!canvas) {
        console.error("‚ùå Canvas do gr√°fico n√£o encontrado!");
        return;
    }

    const largura = canvas.offsetWidth;
    console.log(`üìè Largura do canvas: ${largura}`);

    if (largura === 0) {
        console.warn("‚ö†Ô∏è Canvas ainda sem largura ‚Äî tentando novamente...");
        setTimeout(() => atualizarGraficoUso(dados), 500);
        return;
    }

    const valoresUso = [];
    const valoresPedidoMes = [];
    const labels = [];

    dados.forEach(item => {
        if (!labels.includes(item.nome)) labels.push(item.nome);
    });

    labels.forEach(nome => {
        const uso = dados.find(i => i.nome === nome && i.tipo === 'uso');
        valoresUso.push(uso ? uso.total : 0);

        const pedidoMes = dados.find(i => i.nome === nome && i.tipo === 'pedido_mes');
        valoresPedidoMes.push(pedidoMes ? pedidoMes.total : 0);
    });

    const ctx = canvas.getContext('2d');
    if (window.graficoUso) window.graficoUso.destroy();

    window.graficoUso = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels.map(() => ""), // remove nomes do radar
            datasets: [
                {
                    label: 'Uso atual',
                    data: valoresUso,
                    fill: true,
                    borderColor: 'blue',
                    backgroundColor: 'rgba(0,0,255,0.2)',
                    pointRadius: 5
                },
                {
                    label: 'Pedido do m√™s',
                    data: valoresPedidoMes,
                    fill: false,
                    borderColor: 'red',
                    backgroundColor: 'rgba(255,0,0,0.2)',
                    pointRadius: 5
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.1)' },
                    angleLines: { color: 'rgba(0,0,0,0.2)' },
                    ticks: { color: '#000' }
                }
            },
            plugins: {
                legend: { display: true, labels: { color: '#000' } },
                tooltip: { enabled: true }
            }
        }
    });

    console.log("‚úÖ Gr√°fico criado com sucesso!");
}



// Fun√ß√£o para atualizar o gr√°fico radar
function atualizarGraficoUso(dados) {
    console.log("üìä Iniciando atualiza√ß√£o do gr√°fico...");

    const valoresUso = [];
    const valoresPedidoMes = [];
    const labels = [];

    // Coleta os nomes
    dados.forEach(item => {
        if (!labels.includes(item.nome)) labels.push(item.nome);
    });
    console.log("üî∏ Labels encontrados:", labels);

    // Separa os dados
    labels.forEach(nome => {
        const uso = dados.find(i => i.nome === nome && i.tipo === 'uso');
        const pedidoMes = dados.find(i => i.nome === nome && i.tipo === 'pedido_mes');

        console.log(`üîç Produto: ${nome} | uso=${uso ? uso.total : 0} | pedido_mes=${pedidoMes ? pedidoMes.total : 0}`);

        valoresUso.push(uso ? uso.total : 0);
        valoresPedidoMes.push(pedidoMes ? pedidoMes.total : 0);
    });

    console.log("‚úÖ Valores de uso:", valoresUso);
    console.log("‚úÖ Valores de pedido_mes:", valoresPedidoMes);

    const ctx = document.getElementById('graficoUsoProdutos').getContext('2d');

    if (!ctx) {
        console.error("‚ùå Canvas 'graficoUsoProdutos' n√£o encontrado!");
        return;
    }

    if (window.graficoUso) {
        console.log("üßπ Destruindo gr√°fico antigo...");
        window.graficoUso.destroy();
    }

    console.log("üé® Criando novo gr√°fico...");
    window.graficoUso = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels.map(() => ""), // oculta nomes se quiser
            datasets: [
                {
                    label: 'Uso atual',
                    data: valoresUso,
                    fill: true,
                    borderColor: 'blue',
                    backgroundColor: 'rgba(0,0,255,0.2)',
                    pointRadius: 5
                },
                {
                    label: 'Pedido do m√™s',
                    data: valoresPedidoMes,
                    fill: false,
                    borderColor: 'red',
                    backgroundColor: 'rgba(255,0,0,0.2)',
                    pointRadius: 5
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                r: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.1)' },
                    angleLines: { color: 'rgba(0,0,0,0.2)' },
                    ticks: { color: '#000' }
                }
            },
            plugins: {
                legend: { display: true, labels: { color: '#000' } },
                tooltip: { enabled: true }
            }
        }
    });
   console.log("üìè Largura do canvas:", document.getElementById('graficoUsoProdutos').offsetWidth);
    console.log("‚úÖ Gr√°fico criado com sucesso!");
}




</script>

</body>
</html>

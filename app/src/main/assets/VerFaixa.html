<!DOCTYPE html>
<html lang="pt-BR" class="h-100">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Menu Dashboard</title>
    <link rel="stylesheet" href="Bootstrap/css/bootstrap.css" />
    <link rel="stylesheet" href="Bootstrap/bootstrap-icons.css" />
    <link rel="stylesheet" href="Verfaixa.css" />
    <style>
        /* Destaque visual para faixas em uso */
        .usando {
            border: 2px solid #0d6efd;
            background-color: #e7f1ff;
        }
    </style>
</head>
<body class="bg-light text-dark">

<div class="container py-4">
    <!-- Cabeçalho -->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <a href="menu.html" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
        <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-palette"></i> Estilo
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" onclick="mudarEstiloFaixa('original')">Original</a></li>
                <li><a class="dropdown-item" href="#" onclick="mudarEstiloFaixa('bizarro')">Bizarro</a></li>
                <li><a class="dropdown-item" href="#" onclick="mudarEstiloFaixa('aleatorio')">Aleatório</a></li>
                <li><a class="dropdown-item" href="#" onclick="mudarEstiloFaixa('normal')">Normal</a></li>
            </ul>
        </div>
    </div>

    <!-- Título centralizado -->
    <div class="text-center mb-4">
        <i class="bi bi-collection fs-1 text-primary"></i>
        <h2 class="mt-2">Suas Faixas</h2>
        <p class="text-muted">Veja abaixo a lista de faixas cadastradas.</p>
    </div>

    <!-- Pesquisa -->
    <div class="d-flex mb-4 gap-2">
        <input type="text" class="form-control" id="barraPesquisa" placeholder="Pesquisar faixa...">
        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filtroModal" id="botaoPesquisar">
            <i class="bi bi-filter"></i> Filtrar
        </button>
    </div>

    <!-- Lista de faixas -->
    <div id="faixa-lista" class="row g-3"></div>

    <!-- Modal de edição -->
    <div class="modal fade" id="editarModal" tabindex="-1" aria-labelledby="editarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header d-flex justify-content-between align-items-center">
                    <h5 class="modal-title" id="editarModalLabel">Editar Faixa</h5>
                    <div class="dropdown">
                        <i class="bi bi-gear dropdown-toggle" id="estiloDropdown" data-bs-toggle="dropdown" style="cursor:pointer;"></i>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="estiloDropdown">
                            <a class="dropdown-item" href="#" onclick="event.preventDefault(); mudarEstiloModal('estilo1')">Estilo 1</a>
                            <a class="dropdown-item" href="#" onclick="event.preventDefault(); mudarEstiloModal('bizarro')">Estilo 2</a>
                            <a class="dropdown-item" href="#" onclick="event.preventDefault(); mudarEstiloModal('aleatorio')">Estilo 3</a>
                            <a class="dropdown-item" href="#" onclick="event.preventDefault(); mudarEstiloModal('normal')">Estilo 4</a>
                        </ul>
                    </div>
                </div>
                <div class="modal-body">
                    <form id="formEditarFaixa">
                        <input type="hidden" id="editarId">
                        <div class="mb-3">
                            <label for="editarNome" class="form-label">Nome do Produto</label>
                            <input type="text" class="form-control" id="editarNome" required>
                        </div>
                        <div class="mb-3">
                            <label for="editarTipo" class="form-label">Tipo de Oferta</label>
                            <select class="form-select" id="editarTipo">
                                <option value="SV">SV</option>
                                <option value="Oferta">Oferta</option>
                                <option value="Cartão">Cartão</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editarPrecoOferta" class="form-label">Preço Oferta</label>
                            <input type="number" class="form-control" id="editarPrecoOferta" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="editarPrecoNormal" class="form-label">Preço Normal</label>
                            <input type="number" class="form-control" id="editarPrecoNormal" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="editarIdadeFaixa" class="form-label">Idade da Faixa</label>
                            <select class="form-select" id="editarIdadeFaixa">
                                <option value="Nova">Nova</option>
                                <option value="Nem Nova Nem Velha">Nem Nova Nem Velha</option>
                                <option value="Velha">Velha</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editarCondicao" class="form-label">Condição da Faixa</label>
                            <select class="form-select" id="editarCondicao">
                                <option value="Boa">Boa</option>
                                <option value="Mais ou Menos">Mais ou Menos</option>
                                <option value="Ruim">Ruim</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editarComentario" class="form-label">Comentário</label>
                            <textarea class="form-control" id="editarComentario" rows="2"></textarea>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="editarLimiteCPF">
                            <label class="form-check-label" for="editarLimiteCPF">Limite por CPF</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="salvarEditar">Salvar alterações</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmação -->
    <div id="confirmModal" style="display:none; position:fixed; top:0; left:0;
     width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:8px; text-align:center;">
            <p id="confirmText"></p>
            <button id="confirmYes">Sim</button>
            <button id="confirmNo">Não</button>
        </div>
    </div>

    <!-- Modal de uso da faixa -->
    <div class="modal fade" id="usarModal" tabindex="-1" aria-labelledby="usarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="usarModalLabel">Usar Faixa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p>Informe por quantos dias deseja usar esta faixa:</p>
                    <input type="number" class="form-control" id="diasUsoInput" min="1" value="1">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmarUsarBtn">Usar Faixa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Cancelamento -->
    <div class="modal fade" id="cancelarUsoModal" tabindex="-1" aria-labelledby="cancelarUsoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelarUsoModalLabel">Cancelar Uso da Faixa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p>Deseja realmente cancelar o uso desta faixa?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
                    <button type="button" class="btn btn-danger" id="confirmarCancelarUso">Sim, cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Filtro -->
    <div class="modal fade" id="filtroModal" tabindex="-1" aria-labelledby="filtroModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="filtroModalLabel">Filtrar Faixas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="filtroTipo" class="form-label">Tipo de Oferta</label>
                        <select id="filtroTipo" class="form-select">
                            <option value="">Todos</option>
                            <option value="SV">SV</option>
                            <option value="Oferta">Oferta</option>
                            <option value="Cartão">Cartão</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="filtroEstado" class="form-label">Estado da Faixa</label>
                        <select id="filtroEstado" class="form-select">
                            <option value="">Todos</option>
                            <option value="Nova">Nova</option>
                            <option value="Velha">Velha</option>
                            <option value="Nem Nova Nem Velha">Nem Nova Nem Velha</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="filtroCondicao" class="form-label">Condição da Faixa</label>
                        <select id="filtroCondicao" class="form-select">
                            <option value="">Todos</option>
                            <option value="Boa">Boa</option>
                            <option value="Mais ou Menos">Mais ou Menos</option>
                            <option value="Ruim">Ruim</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="filtroLimiteCPF" class="form-label">Limite por CPF</label>
                        <select id="filtroLimiteCPF" class="form-select">
                            <option value="">Todos</option>
                            <option value="1">Sim</option>
                            <option value="0">Não</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="filtroUso" class="form-label">Faixa em Uso</label>
                        <select id="filtroUso" class="form-select">
                            <option value="">Todos</option>
                            <option value="1">Sim</option>
                            <option value="0">Não</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="aplicarFiltroBtn">Aplicar Filtro</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="Bootstrap/js/bootstrap.bundle.js"></script>
<script>
    let faixaIdParaExcluir = null;
    let faixaAtualParaEditar = null;
    let estiloAtual = 'original';
    let faixaIdParaUsar = null;
    let faixaIdParaCancelar = null;

    const editarModalEl = document.getElementById("editarModal");
    const editarBootstrapModal = new bootstrap.Modal(editarModalEl);
    const usarModalEl = document.getElementById("usarModal");
    const usarBootstrapModal = new bootstrap.Modal(usarModalEl);
    const cancelarUsoModalEl = document.getElementById("cancelarUsoModal");
    const cancelarUsoBootstrapModal = new bootstrap.Modal(cancelarUsoModalEl);
    const editarTipo = document.getElementById('editarTipo');
    const editarPrecoNormalDiv = document.getElementById('editarPrecoNormal').parentElement;

    // Atualiza visibilidade do Preço Normal
    function atualizarPrecoNormal() {
        editarPrecoNormalDiv.style.display = editarTipo.value === 'Oferta' ? 'none' : 'block';
    }
    editarTipo.addEventListener('change', atualizarPrecoNormal);

    // Função para carregar e exibir as faixas
    function carregarFaixas(faixas) {
        const container = document.getElementById('faixa-lista');
        container.innerHTML = '';

        if (!faixas || faixas.length === 0) {
            container.innerHTML = '<p>Nenhuma faixa encontrada.</p>';
            return;
        }

        faixas.forEach(faixa => {
            const div = document.createElement('div');
            div.className = 'faixa-item';
            if (estiloAtual !== 'original') div.classList.add(estiloAtual);
            if (faixa.usando === 1) div.classList.add('usando');

            let statusUso = faixa.usando === 1 ? `<p><strong>Usando</strong></p>` : '';
            let btnUsar = criarBotaoUsar(faixa);

            div.innerHTML = `
                 <div class="faixa-header">
        <small class="faixa-id">ID: ${faixa.codigo_faixa}</small>
        <h3>${faixa.nome_produto}</h3>
    </div>
                <div class="faixa-info tipo-oferta text-center mb-2"><strong>Tipo de Oferta:</strong> ${faixa.tipo_oferta}</div>
                <div class="faixa-precos d-flex justify-content-center gap-4 mb-2">
                    <div><strong>Preço Oferta:</strong> ${typeof faixa.preco_oferta === 'number' ? faixa.preco_oferta.toFixed(2) : '-'}</div>
<div><strong>Preço Normal:</strong> ${typeof faixa.preco_normal === 'number' ? faixa.preco_normal.toFixed(2) : '-'}</div>

                </div>
                <hr class="faixa-separator">
                <div class="faixa-info-extra d-flex justify-content-center gap-4 mb-2">
                    <div><strong>Estado:</strong> ${faixa.estado_faixa}</div>
                    <div><strong>Condição:</strong> ${faixa.condicao_faixa}</div>
                </div>
                <div class="faixa-info mb-2">
                    <p><strong>Comentário:</strong> ${faixa.comentario || '-'}</p>
                    <p><strong>Limite CPF:</strong> ${faixa.limite_cpf === 1 ? 'Sim' : 'Não'}</p>
                    <p><strong>Vezes usada:</strong> ${faixa.vezes_usada}</p>
                    <div><strong>Tempo:</strong> ${faixa.tempo_faixa || '-'}</div>
                    ${statusUso}
                </div>
                <hr class="faixa-separator">
                ${faixa.usando === 1 ? `
                    <h6 class="text-danger fw-bold">FAIXA SENDO USADA</h6>
                    <div class="text-center mt-2 faixa-info">
                        <p>Início: ${faixa.data_inicio_uso || '-'}</p>
                        <p>Dias de uso: ${faixa.dias_uso || 0}</p>
                        <p>Dias restantes: ${faixa.dias_restantes || 0}</p>
                    </div>
                ` : ''}
                <div class="faixa-actions">
                    <button class="btn btn-warning" onclick='abrirEditarFaixa(${JSON.stringify(faixa)})'>Editar</button>
                    ${btnUsar}
                    <button class="btn btn-danger" onclick="excluirFaixa(${faixa.id}, '${faixa.nome_produto}')">Excluir</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // Botão Usar ou Cancelar
    function criarBotaoUsar(faixa) {
        if (faixa.usando === 1) {
            return `<button class="btn btn-secondary" onclick='cancelarUso(${faixa.id})'>Cancelar Uso</button>`;
        } else {
            return `<button class="btn btn-success" onclick='usarFaixaPrompt(${faixa.id})'>Usar Faixa</button>`;
        }
    }



    // Editar faixa
function abrirEditarFaixa(faixa) {
    console.log('--- Abrindo modal de edição ---');
    console.log('Objeto recebido:', faixa);

    faixaAtualParaEditar = faixa;

    // Campos básicos
    document.getElementById('editarNome').value = faixa.nome_produto || '';
    console.log('Nome do produto:', faixa.nome_produto);

    document.getElementById('editarPrecoOferta').value = faixa.preco_oferta || '';
    console.log('Preço oferta:', faixa.preco_oferta);

    document.getElementById('editarPrecoNormal').value = faixa.preco_normal || '';
    console.log('Preço normal:', faixa.preco_normal);

    document.getElementById('editarComentario').value = faixa.comentario || '';
    console.log('Comentário:', faixa.comentario);

    document.getElementById('editarLimiteCPF').checked = faixa.limite_cpf === 1;
    console.log('Limite CPF:', faixa.limite_cpf);

    // --- Normalizar Tipo de Oferta ---
    let tipo = (faixa.tipo_oferta || '').trim().toLowerCase();
    console.log('Tipo original:', faixa.tipo_oferta, '-> normalizado para minúsculo e trim:', tipo);

    switch (tipo) {
        case 'sv': tipo = 'SV'; break;
        case 'oferta': tipo = 'Oferta'; break;
        case 'cartao':
        case 'cartão': tipo = 'Cartão'; break;
        default: tipo = 'SV';
    }
    console.log('Tipo final atribuído ao select:', tipo);
    document.getElementById('editarTipo').value = tipo;

    // --- Normalizar Idade da Faixa ---
    let estado = (faixa.estado_faixa || '').trim().toLowerCase();
    console.log('Estado original:', faixa.estado, '-> normalizado:', estado);

    switch (estado) {
        case 'nova': estado = 'Nova'; break;
        case 'velha': estado = 'Velha'; break;
        case 'nem nova nem velha': estado = 'Nem Nova Nem Velha'; break;
        default: estado = 'Nova';
    }
    console.log('Estado final atribuído ao select:', estado);
    document.getElementById('editarIdadeFaixa').value = estado;

    // --- Normalizar Condição da Faixa ---
    let condicao = (faixa.condicao_faixa || '').trim().toLowerCase();
    console.log('Condição original:', faixa.condicao, '-> normalizado:', condicao);

    switch (condicao) {
        case 'boa': condicao = 'Boa'; break;
        case 'mais ou menos':
        case 'mais ou meno': condicao = 'Mais ou Menos'; break;
        case 'ruim': condicao = 'Ruim'; break;
        default: condicao = 'Boa';
    }
    console.log('Condição final atribuído ao select:', condicao);
    document.getElementById('editarCondicao').value = condicao;

    // Atualiza preços e mostra modal
    atualizarPrecoNormal();
    editarBootstrapModal.show();
    console.log('Modal aberto.');
}


// Salvar alterações
document.getElementById('salvarEditar').addEventListener('click', () => {
    if (!faixaAtualParaEditar) return;

    const dadosAtualizados = {
        id: faixaAtualParaEditar.id,
        nome_produto: document.getElementById('editarNome').value,
        tipo_oferta: document.getElementById('editarTipo').value,
        preco_oferta: parseFloat(document.getElementById('editarPrecoOferta').value || 0),
        preco_normal: parseFloat(document.getElementById('editarPrecoNormal').value || 0),
        estado: document.getElementById('editarIdadeFaixa').value,
        condicao: document.getElementById('editarCondicao').value,
        comentario: document.getElementById('editarComentario').value,
        limite_cpf: document.getElementById('editarLimiteCPF').checked ? 1 : 0
    };

    Android.editarFaixa(
        dadosAtualizados.id,
        dadosAtualizados.nome_produto,
        dadosAtualizados.tipo_oferta,
        dadosAtualizados.preco_oferta,
        dadosAtualizados.preco_normal,
        dadosAtualizados.estado,
        dadosAtualizados.condicao,
        dadosAtualizados.comentario,
        dadosAtualizados.limite_cpf
    );

    editarBootstrapModal.hide();
});



    // Mudar estilo das faixas
    function mudarEstiloFaixa(estilo) {
        const faixas = document.querySelectorAll('.faixa-item');
        ['original', 'bizarro', 'aleatorio'].forEach(c => faixas.forEach(faixa => faixa.classList.remove(c)));
        if (estilo !== 'original') faixas.forEach(faixa => faixa.classList.add(estilo));
        estiloAtual = estilo;
    }

    // Usar faixa
    function usarFaixaPrompt(id) {
        faixaIdParaUsar = id;
        document.getElementById("diasUsoInput").value = 1;
        usarBootstrapModal.show();
    }

    document.getElementById("confirmarUsarBtn").addEventListener("click", () => {
        const dias = parseInt(document.getElementById("diasUsoInput").value) || 0;
        if (faixaIdParaUsar !== null && dias > 0) {
            Android.usarFaixa(faixaIdParaUsar, dias);
            usarBootstrapModal.hide();
        } else alert("Informe um número de dias válido.");
    });

    // Cancelar uso
    function cancelarUso(id) {
        faixaIdParaCancelar = id;
        cancelarUsoBootstrapModal.show();
    }

    document.getElementById("confirmarCancelarUso").addEventListener("click", () => {
        if (faixaIdParaCancelar !== null) {
            Android.cancelarUsoFaixa(faixaIdParaCancelar);
            faixaIdParaCancelar = null;
            cancelarUsoBootstrapModal.hide();
        }
    });

    // Excluir faixa
    function excluirFaixa(id, nome) {
        faixaIdParaExcluir = id;
        document.getElementById("confirmText").innerText = `Deseja realmente excluir a faixa "${nome}"?`;
        document.getElementById("confirmModal").style.display = "flex";
    }

    document.getElementById("confirmYes").addEventListener("click", () => {
        Android.excluirFaixa(faixaIdParaExcluir);
        document.getElementById("confirmModal").style.display = "none";
    });
    document.getElementById("confirmNo").addEventListener("click", () => {
        document.getElementById("confirmModal").style.display = "none";
    });

    // Pesquisa
   function pesquisar() {
    const texto = document.getElementById('barraPesquisa').value;
    console.log('Pesquisa enviada:', texto); // LOG da pesquisa
    if (window.Android && window.Android.pesquisarFaixa) {
        window.Android.pesquisarFaixa(texto);
        console.log('Chamou Android.pesquisarFaixa'); // LOG do envio para Android
    } else {
        console.warn('Android.pesquisarFaixa não disponível'); // LOG caso Android não exista
    }
}

document.getElementById('botaoPesquisar').addEventListener('click', pesquisar);
document.getElementById('barraPesquisa').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') pesquisar();
});
    document.getElementById('botaoPesquisar').addEventListener('click', pesquisar);
    document.getElementById('barraPesquisa').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') pesquisar();
    });

    // Ao carregar a página, busca todas as faixas
    window.onload = function() {
        if (window.Android && window.Android.pesquisarFaixa) {
            window.Android.pesquisarFaixa('');
        }
    };

    document.getElementById('aplicarFiltroBtn').addEventListener('click', () => {
    const filtro = {
        tipo: document.getElementById('filtroTipo').value,
        estado: document.getElementById('filtroEstado').value,
        condicao: document.getElementById('filtroCondicao').value,
        limite_cpf: document.getElementById('filtroLimiteCPF').value,
        em_uso: document.getElementById('filtroUso').value
    };

    if (window.Android && window.Android.filtrarFaixas) {
        window.Android.filtrarFaixas(JSON.stringify(filtro));
    }

    const filtroModal = bootstrap.Modal.getInstance(document.getElementById('filtroModal'));
    filtroModal.hide();
});

    const filtroModalEl = document.getElementById('filtroModal');
const filtroBootstrapModal = bootstrap.Modal.getInstance(filtroModalEl) || new bootstrap.Modal(filtroModalEl);

// Reseta o modal ao fechar
filtroModalEl.addEventListener('hidden.bs.modal', () => {
    document.getElementById('filtroTipo').value = '';
    document.getElementById('filtroEstado').value = '';
    document.getElementById('filtroCondicao').value = '';
    document.getElementById('filtroLimiteCPF').value = '';
    document.getElementById('filtroUso').value = '';
});
</script>

</body>
</html>
